<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Centrifugo WS JSON‑RPC Simulator</title>
    <style>
      :root {
        --bg: #0b0f17;
        --panel: #111827;
        --muted: #94a3b8;
        --text: #e5e7eb;
        --border: #1f2937;
        --ok: #10b981;
        --warn: #f59e0b;
        --err: #ef4444;
        --accent: #60a5fa;
        --chip: #1f2937;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font: 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      }
      header {
        position: sticky;
        top: 0;
        background: rgba(11, 15, 23, 0.9);
        backdrop-filter: blur(6px);
        border-bottom: 1px solid var(--border);
        padding: 14px 18px;
        z-index: 10;
      }
      h1 {
        margin: 0;
        font-size: 16px;
      }
      .wrap {
        display: grid;
        grid-template-columns: 420px 1fr;
        gap: 18px;
        padding: 18px;
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 14px;
      }
      h2 {
        margin: 0 0 10px;
        font-size: 14px;
      }
      .row {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
      }
      label {
        color: var(--muted);
        font-size: 12px;
      }
      input[type="text"],
      input[type="number"],
      textarea {
        width: 100%;
        background: #0f172a;
        border: 1px solid var(--border);
        border-radius: 10px;
        color: var(--text);
        padding: 9px 11px;
      }
      textarea {
        height: 90px;
        resize: vertical;
      }
      .hint {
        color: var(--muted);
        font-size: 12px;
        margin: -4px 0 8px;
      }
      .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .btn {
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #0f172a;
        color: var(--text);
        padding: 9px 12px;
        cursor: pointer;
        font-weight: 600;
      }
      .btn.primary {
        background: linear-gradient(180deg, #2563eb, #1d4ed8);
        border-color: transparent;
      }
      .btn.danger {
        background: #7f1d1d;
        border-color: #7f1d1d;
      }
      .status {
        display: flex;
        gap: 8px;
        align-items: center;
        font-size: 12px;
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: #4b5563;
      }
      .dot.ok {
        background: var(--ok);
      }
      .dot.err {
        background: var(--err);
      }
      .log {
        height: 520px;
        overflow: auto;
        background: #0b1120;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 8px;
      }
      .entry {
        display: grid;
        grid-template-columns: 110px 90px 1fr;
        gap: 8px;
        padding: 7px 8px;
        border-bottom: 1px dashed #1f2937;
      }
      .entry:last-child {
        border-bottom: none;
      }
      .ts {
        color: var(--muted);
        font-size: 12px;
      }
      .dir {
        font-size: 12px;
      }
      .in {
        color: var(--ok);
      }
      .out {
        color: var(--accent);
      }
      .info {
        color: var(--muted);
      }
      .warn {
        color: var(--warn);
      }
      .err {
        color: var(--err);
      }
      pre {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-word;
        font: 12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        color: #e2e8f0;
      }
      .kbd {
        padding: 2px 6px;
        border-radius: 6px;
        background: #111827;
        border: 1px solid var(--border);
        color: #cbd5e1;
        font-size: 11px;
      }
      @media (max-width: 980px) {
        .wrap {
          grid-template-columns: 1fr;
        }
        .log {
          height: 360px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Centrifugo WS JSON‑RPC Simulator</h1>
    </header>

    <div class="wrap">
      <section class="card">
        <h2>1) Cấu hình & lấy JWT</h2>
        <div class="row">
          <label>WS URL</label>
          <input id="url" type="text" value="ws://127.0.0.1:18081/connection/websocket" />
        </div>
        <div class="hint">
          Gợi nhanh: <span class="kbd" onclick="setUrl('ws://127.0.0.1:8000/connection/websocket')">:8000 trực tiếp</span>
          <span class="kbd" onclick="setUrl('ws://127.0.0.1:18081/connection/websocket')">:18081 qua Nginx</span>
        </div>
        <div class="row">
          <label>Subprotocol</label>
          <div>
            <input id="useProto" type="checkbox" /> <span class="hint">Dùng <code>centrifugo</code> (không bắt buộc)</span>
          </div>
        </div>
        <div class="row">
          <label>JWT_with_subs</label>
          <textarea id="token" placeholder="Dán JWT vào đây hoặc nhấn Lấy token từ BE"></textarea>
        </div>
        <div class="actions">
          <button class="btn primary" id="btnConnect">Kết nối & gửi CONNECT</button>
          <button class="btn" id="btnDisconnect">Ngắt kết nối</button>
          <button class="btn" id="btnCopyFrame">Copy CONNECT frame</button>
        </div>
        <div class="hint">
          Frame CONNECT đúng chuẩn Centrifugo (bidirectional JSON):
          <span class="kbd">{"id":1,"connect":{"token":"&lt;JWT&gt;"}}</span>
        </div>

        <hr style="border: none; border-top: 1px solid var(--border); margin: 14px 0" />

        <h2>2) Lấy token từ BE</h2>
        <div class="row">
          <label>API Base</label>
          <input id="apiBase" type="text" value="http://localhost:3000" />
        </div>
        <div class="row">
          <label>Route</label>
          <input id="apiPath" type="text" value="/centrifugo/endpoint-connect-token" />
        </div>
        <div class="row">
          <label>endpoint_id</label>
          <input id="epId" type="number" placeholder="vd 72" />
        </div>
        <div class="row">
          <label>Auth</label>
          <div>
            <label style="display: flex; gap: 6px; align-items: center"><input id="useCreds" type="checkbox" checked /> <span class="hint">Gửi cookie (credentials: include)</span></label>
            <input id="bearer" type="text" placeholder="Bearer access token (tuỳ chọn)" style="margin-top: 8px" />
          </div>
        </div>
        <div class="actions">
          <button class="btn" id="btnGetToken">Gọi API lấy token</button>
          <div class="status" id="status"><span class="dot"></span><span>Chưa kết nối</span></div>
        </div>
      </section>

      <section class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 8px">
          <h2>Console</h2>
          <div class="actions">
            <button class="btn" id="btnClear">Clear</button>
            <button class="btn" id="btnCopyLast">Copy last</button>
          </div>
        </div>
        <div class="log" id="log"></div>

        <hr style="border: none; border-top: 1px solid var(--border); margin: 14px 0" />

        <h2>Gửi frame tuỳ ý</h2>
        <div class="row">
          <label>Payload</label>
          <textarea id="custom" placeholder='{"id":2,"subscribe":{"channel":"pj:16:ep:72"}}'></textarea>
        </div>
        <div class="actions">
          <button class="btn" id="btnSend">Gửi frame</button>
        </div>
      </section>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const logBox = $("log");
      let ws = null;
      let nextId = 1;
      let last = "";

      function setUrl(u) {
        $("url").value = u;
      }
      function ts() {
        return new Date().toLocaleTimeString();
      }
      function add(kind, dir, data) {
        const row = document.createElement("div");
        row.className = "entry";
        const a = document.createElement("div");
        a.className = "ts";
        a.textContent = ts();
        const b = document.createElement("div");
        b.className = dir;
        b.textContent = dir.toUpperCase();
        const c = document.createElement("pre");
        try {
          c.textContent = typeof data === "string" ? data : JSON.stringify(data, null, 2);
          last = c.textContent;
        } catch (e) {
          c.textContent = String(data);
        }
        row.append(a, b, c);
        logBox.append(row);
        logBox.scrollTop = logBox.scrollHeight;
      }
      function setStatus(ok, text) {
        const s = $("status");
        const dot = s.querySelector(".dot");
        dot.className = "dot " + (ok ? "ok" : "");
        s.lastChild.textContent = text;
      }

      function buildConnect() {
        const token = $("token").value.trim();
        const id = nextId++;
        // Centrifugo expects command-style JSON: { id, connect: { token } }
        return JSON.stringify({ id, connect: { token } });
      }

      function connect() {
        const url = $("url").value.trim();
        const token = $("token").value.trim();
        const useProto = $("useProto").checked;
        if (!url) {
          add("err", "err", "Thiếu WS URL");
          return;
        }
        if (!token) {
          add("warn", "warn", "Chưa có JWT");
        }
        try {
          if (ws && ws.readyState === WebSocket.OPEN) ws.close(1000, "reconnect");
          ws = useProto ? new WebSocket(url, ["centrifugo"]) : new WebSocket(url);
        } catch (e) {
          add("err", "err", "WebSocket init error: " + e.message);
          return;
        }
        ws.onopen = () => {
          add("info", "info", "OPEN " + url + (useProto ? " (subprotocol: centrifugo)" : ""));
          const frame = buildConnect();
          ws.send(frame);
          add("out", "out", frame);
          setStatus(true, "Đã kết nối");
        };
        ws.onmessage = (ev) => {
          let data = ev.data;
          try {
            data = JSON.parse(ev.data);
          } catch {}
          add("in", "in", data);
        };
        ws.onerror = () => {
          add("err", "err", "WS error");
          setStatus(false, "Lỗi");
        };
        ws.onclose = (ev) => {
          add("warn", "warn", `CLOSE code=${ev.code} reason=${ev.reason || "—"}`);
          setStatus(false, "Đã ngắt");
        };
      }

      function disconnect() {
        if (ws) {
          try {
            ws.close(1000, "manual");
          } catch {}
        }
      }

      async function getToken() {
        const base = $("apiBase").value.trim().replace(/\/$/, "");
        const path = $("apiPath").value.trim() || "/centrifugo/endpoint-connect-token";
        const ep = Number($("epId").value.trim());
        const creds = $("useCreds").checked;
        const bearer = $("bearer").value.trim();
        if (!ep) {
          add("warn", "warn", "endpoint_id chưa có");
          return;
        }
        const url = base + path;
        const headers = { "Content-Type": "application/json" };
        if (bearer) headers["Authorization"] = "Bearer " + bearer;
        add("info", "info", "Fetching token: " + url);
        try {
          const res = await fetch(url, { method: "POST", credentials: creds ? "include" : "omit", headers, body: JSON.stringify({ endpoint_id: ep }) });
          const json = await res.json();
          add("in", "in", json);
          if (res.ok && json.token) {
            $("token").value = json.token;
            add("info", "info", "Token đã điền vào ô JWT");
          } else add("err", "err", "Không lấy được token (HTTP " + res.status + ")");
        } catch (e) {
          add("err", "err", "Fetch error: " + e.message);
        }
      }

      function sendCustom() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          add("warn", "warn", "WS chưa mở");
          return;
        }
        const raw = $("custom").value.trim();
        if (!raw) return;
        try {
          JSON.parse(raw);
          ws.send(raw);
          add("out", "out", raw);
        } catch {
          add("err", "err", "Payload không phải JSON hợp lệ");
        }
      }

      $("btnConnect").onclick = connect;
      $("btnDisconnect").onclick = disconnect;
      $("btnGetToken").onclick = getToken;
      $("btnSend").onclick = sendCustom;
      $("btnClear").onclick = () => (logBox.innerHTML = "");
      $("btnCopyLast").onclick = () => last && navigator.clipboard.writeText(last);
      $("btnCopyFrame").onclick = () => navigator.clipboard.writeText(buildConnect());
    </script>
  </body>
</html>
