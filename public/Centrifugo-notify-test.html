<!DOCTYPE html>
<html>
  <body>
    <h3>Centrifugo Test (Secure)</h3>
    <pre id="log">starting...</pre>

    <!-- axios (UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/axios@1/dist/axios.min.js"></script>
    <!-- Centrifuge (UMD) ‚Üí t·∫°o window.Centrifuge -->
    <script src="https://cdn.jsdelivr.net/npm/centrifuge@5/dist/centrifuge.min.js" onload="window.__CENT_OK__=true"></script>

    <script>
      const logEl = document.getElementById("log");
      const log = (...a) => (logEl.textContent += "\n" + a.join(" "));

      const BE = "http://127.0.0.1:3000";
      const WS_URL = "ws://127.0.0.1:8000/connection/websocket"; // v6 KH√îNG c·∫ßn ?format=json
      const SUB_CHANNEL = "notification#mock_logging";

      (async function main() {
        try {
          // üîê ƒêƒÉng nh·∫≠p tr·ª±c ti·∫øp ƒë·ªÉ set cookie trong browser
          log("‚Üí Logging in...");
          const loginResp = await axios.post(
            `${BE}/auth/login`,
            {
              username: "vinh1",
              password: "12345678",
            },
            { withCredentials: true }
          );

          const data = loginResp.data;
          if (!data?.token) {
            log("‚ö†Ô∏è Login response:", JSON.stringify(data));
          } else {
            log("‚úÖ Login OK, token prefix:", data.token.slice(0, 10));
          }

          // üß© Ki·ªÉm tra l·∫°i user t·ª´ cookie
          const meResp = await axios.get(`${BE}/auth/me`, { withCredentials: true });
          const me = meResp.data;
          log("üë§ Logged in as:", me.username, "(id:", me.id, ")");
          const userId = me.id;

          // 1Ô∏è‚É£ Xin connection token
          const connRes = await axios.get(`${BE}/centrifugo/conn-token`, {
            withCredentials: true,
          });
          const conn = connRes.data;
          log("‚úÖ conn token ok, user:", conn.user_id);

          // 2Ô∏è‚É£ T·∫°o Centrifuge instance
          const centrifuge = new window.Centrifuge(WS_URL, { token: conn.token });

          // 3Ô∏è‚É£ Xin sub-token
          const subRes = await axios.get(`${BE}/centrifugo/sub-token`, {
            params: { channel: SUB_CHANNEL },
            withCredentials: true,
          });
          const subTok = subRes.data;

          // 4Ô∏è‚É£ ƒêƒÉng k√Ω subscription
          const sub = centrifuge.newSubscription(SUB_CHANNEL, { token: subTok.token });
          sub.on("publication", (ctx) => {
            log("üì® Notification:", JSON.stringify(ctx.data));
          });
          sub.on("subscribed", () => log("‚úÖ subscribed"));
          sub.on("error", (e) => log("sub error", e));
          sub.subscribe();

          centrifuge.on("connected", () => log("‚úÖ connected"));
          centrifuge.on("error", (e) => log("conn error", e));
          centrifuge.connect();
        } catch (err) {
          const data = err.response?.data;
          if (data) {
            log("‚ùå init error:", JSON.stringify(data, null, 2));
          } else {
            log("‚ùå init error:", err.message || err);
          }
        }
      })();
    </script>
  </body>
</html>
